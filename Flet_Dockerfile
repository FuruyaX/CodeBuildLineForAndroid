FROM androidbuilder

ARG TOOL
ARG AFTER_SHELL

# Python & ビルドツールのインストール
RUN apt update && apt install -y \
    python3-pip \
    build-essential \
    libssl-dev \
    zlib1g-dev \
    libbz2-dev \
    libreadline-dev \
    libsqlite3-dev \
    curl \
    libncursesw5-dev \
    tk-dev \
    libxml2-dev \
    libxmlsec1-dev \
    libffi-dev \
    liblzma-dev \
    libmpv-dev \
    python3.12-venv \
    git \
    xz-utils \
    wget

# Python仮想環境の準備
RUN python3.12 -m venv ${TOOL}/venv

# Flet/Poetry の依存関係インストール
COPY TOOL/requirement.txt ${TOOL}/
RUN ${TOOL}/venv/bin/pip install --no-cache-dir -r ${TOOL}/requirement.txt

# Flutter SDK のインストール
WORKDIR ${TOOL}
RUN wget https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_3.27.1-stable.tar.xz && \
    tar xf flutter_linux_3.27.1-stable.tar.xz && \
    rm flutter_linux_3.27.1-stable.tar.xz

# 後処理スクリプトの配置
COPY TOOL/${AFTER_SHELL} ${TOOL}/

# 実行時に仮想環境を有効化してシェル起動
CMD ["/bin/bash", "-c", "source ${TOOL}/venv/bin/activate && bash ${TOOL}/${AFTER_SHELL}"]